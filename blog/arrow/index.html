<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" as="font" href="https://cda-group.github.io/arcon/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="https://cda-group.github.io/arcon/fonts/vendor/jost/jost-v4-latin-700.woff2"  type="font/woff2" crossorigin>


<link rel="stylesheet" href="https://cda-group.github.io/arcon/main.css">



  
  
  
  
  
    
  

  
  
    
    
  
  
  
    
  
  
  
  
    
  
  
  


  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">


	


	

<title>Betting on Arrow | Arcon</title>
<meta name="description" content="">
<link rel="canonical" href="https://cda-group.github.io/arcon/blog/arrow/">










<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://cda-group.github.io/arcon/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Blog",
            "item": "https://cda-group.github.io/arcon/blog/"
          },
        
      
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Arrow",
            "item": "https://cda-group.github.io/arcon/blog/arrow/"
          },
        
      
    
  }
</script>







  <meta name="theme-color" content="#fff">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cda-group.github.io/arcon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cda-group.github.io/arcon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cda-group.github.io/arcon/favicon-16x16.png">
  
    <link rel="manifest" href="https://cda-group.github.io/arcon/site.webmanifest" crossorigin>
  


  

</head>

  

<body class="blog single">
  
  
<div class="header-bar fixed-top"></div>
<header class="navbar fixed-top navbar-expand-md navbar-light">
	<div class="container">
		<input class="menu-btn order-0" type="checkbox" id="menu-btn">
		<label class="menu-icon d-md-none" for="menu-btn"><span class="navicon"></span></label>
		<a class="navbar-brand order-1 order-md-0 me-auto" href="https://cda-group.github.io/arcon">Arcon</a>
		<button id="mode" class="btn btn-link order-2 order-md-4" type="button" aria-label="Toggle mode">
			<span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
			<span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
		</button>
		<ul class="navbar-nav fork-me order-3 order-md-5">
			
				
					<li class="nav-item">
						<a class="nav-link" href="https://github.com/cda-group/arcon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a>
					</li>
				
			
		</ul>
		<div class="collapse navbar-collapse order-4 order-md-1">
			<ul class="navbar-nav main-nav me-auto order-5 order-md-2">
				
					
				
				
				
					
						<li class="nav-item">
							<a class="nav-link" href="https://cda-group.github.io/arcon/docs/arcon/about/">Learn</a>
						</li>
					
						<li class="nav-item blog active">
							<a class="nav-link" href="https://cda-group.github.io/arcon/blog/">Blog</a>
						</li>
					
				
			</ul>
			<div class="break order-6 d-md-none"></div>
			
				<form class="navbar-form flex-grow-1 order-7 order-md-3">
					<input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
						aria-label="Search docs..." autocomplete="off">
					<div id="suggestions" class="shadow bg-white rounded"></div>
				</form>
			
		</div>
	</div>
</header>



  
<div class="wrap container" role="document">
  <div class="content">
    <div class="row justify-content-center">
      <div class="col-md-12 col-lg-10 col-xxl-8">
        <article>
          <div class="blog-header">
            <h1>Betting on Arrow</h1>
            
<p><small>Posted 2021-03-31 05:19:42 by <a class="stretched-link position-relative" href="https://cda-group.github.io/arcon/authors/max-meldrum/">Max Meldrum</a>&nbsp;&hyphen;&nbsp;<strong>7&nbsp;min read</strong></small><p>

          </div>
          
          <h1 id="introduction">Introduction</h1>
<p>Like many other data processing systems, <a href="https://github.com/cda-group/arcon">Arcon</a> is also betting on the <a href="https://arrow.apache.org/">Arrow</a> format. </p>
<p>Arcon has until recently been a pure row-based (Protobuf) system. While this data arrangement works for a range of streaming operations, it is not suitable for ad-hoc OLAP queries or larger bulk aggregations on streaming windows.
With a Columnar format, we gain a lot from vectorised processing (SIMD) and the fact that we can share internal Arcon state with other systems through interfaces such as <code>Arrow Flight</code>.</p>
<p>In this post, we'll go through how Arcon handles the conversion from Protobuf to Arrow data.</p>
<p>Sections:</p>
<ul>
<li><a href="https://cda-group.github.io/arcon/blog/arrow/#defining-protobuf-data-in-arcon">Defining Protobuf data in Arcon</a></li>
<li><a href="https://cda-group.github.io/arcon/blog/arrow/#working-with-arrow">Working with Arrow</a></li>
<li><a href="https://cda-group.github.io/arcon/blog/arrow/#arrow-derive-macro">Arrow Derive Macro</a></li>
<li><a href="https://cda-group.github.io/arcon/blog/arrow/#fixed-limitations">Fixed Limitations</a></li>
<li><a href="https://cda-group.github.io/arcon/blog/arrow/#current-limitations">Current Limitations</a></li>
<li><a href="https://cda-group.github.io/arcon/blog/arrow/#conclusion">Conclusion</a></li>
</ul>
<h2 id="defining-protobuf-data-in-arcon">Defining Protobuf data in Arcon</h2>
<p>Let's first go over the structure of an <code>ArconType</code>. Down below you can see its Rust trait. </p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub trait </span><span>ArconType: ArconTypeBounds
</span><span>where
</span><span>    Self: std::marker::Sized,
</span><span>{
</span><span>    #[</span><span style="color:#bf616a;">cfg</span><span>(feature = &quot;</span><span style="color:#a3be8c;">unsafe_flight</span><span>&quot;)]
</span><span>    </span><span style="color:#65737e;">/// Serialisation ID for Arcon&#39;s Unsafe In-flight serde
</span><span>    </span><span style="color:#b48ead;">const </span><span style="color:#d08770;">UNSAFE_SER_ID</span><span>: SerId;
</span><span>    </span><span style="color:#65737e;">/// Serialisation ID for Arcon&#39;s Reliable In-flight serde
</span><span>    </span><span style="color:#b48ead;">const </span><span style="color:#d08770;">RELIABLE_SER_ID</span><span>: SerId;
</span><span>    </span><span style="color:#65737e;">/// Current version of this ArconType
</span><span>    </span><span style="color:#b48ead;">const </span><span style="color:#d08770;">VERSION_ID</span><span>: VersionId;
</span><span>
</span><span>    </span><span style="color:#65737e;">/// Return the key of this ArconType
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">get_key</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>) -&gt; </span><span style="color:#b48ead;">u64</span><span>;
</span><span>}
</span></code></pre>
<p>It is in the <code>ArconTypeBounds</code> trait that we set the requirement that the type must be a Protobuf supported message. This is done through the <a href="https://github.com/danburkert/prost">prost</a> crate and its <code>Message</code> trait. More details on the ArconType may be found <a href="https://cda-group.github.io/arcon/introduction/data_format.html#arcontype">here</a>.</p>
<p>To implement an ArconType we use the <code>Arcon</code> derive macro as seen below.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">arcon</span><span>::</span><span style="color:#bf616a;">proto</span><span>]
</span><span>#[</span><span style="color:#bf616a;">derive</span><span>(Arcon, Clone)]
</span><span style="color:#b48ead;">pub struct </span><span>Event {
</span><span>  </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">f1</span><span>: </span><span style="color:#b48ead;">u64</span><span>,
</span><span>  </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">f2</span><span>: String,
</span><span>  </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">f3</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span></code></pre>
<p>The above Rust struct is equivalent to the following Protobuf message:</p>
<pre data-lang="proto" style="background-color:#2b303b;color:#c0c5ce;" class="language-proto "><code class="language-proto" data-lang="proto"><span style="color:#b48ead;">message </span><span style="color:#ebcb8b;">Event </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">  uint64 </span><span style="color:#bf616a;">f1 </span><span>= </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">  string </span><span style="color:#bf616a;">f2 </span><span>= </span><span style="color:#d08770;">2</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">  double </span><span style="color:#bf616a;">f3 </span><span>= </span><span style="color:#d08770;">3</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">}
</span></code></pre>
<p>Right, so at this point, we have defined our Protobuf data. Next, we'll go through the steps of the Arrow conversion.</p>
<h2 id="working-with-arrow">Working with Arrow</h2>
<p>Converting the <code>Event</code> struct to Arrow data is not straightforward.
The Arrow <a href="https://github.com/apache/arrow/tree/master/rust/arrow">crate</a> provides a bunch of low-level builder types that we can use. Let's go through an example where we build everything manually.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> capacity = </span><span style="color:#d08770;">1024</span><span>;
</span><span>
</span><span style="color:#b48ead;">let mut</span><span> f1_builder = UInt64Builder::new(capacity);
</span><span style="color:#b48ead;">let mut</span><span> f2_builder = StringBuilder::new(capacity);
</span><span style="color:#b48ead;">let mut</span><span> f3_builder = Float64Builder::new(capacity);
</span><span>
</span><span style="color:#65737e;">// Append a single value to each builder
</span><span>f1_builder.</span><span style="color:#96b5b4;">append_value</span><span>(</span><span style="color:#d08770;">1</span><span>).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>f2_builder.</span><span style="color:#96b5b4;">append_value</span><span>(String::from(&quot;</span><span style="color:#a3be8c;">data</span><span>&quot;)).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>f3_builder.</span><span style="color:#96b5b4;">append_value</span><span>(</span><span style="color:#d08770;">10.5</span><span>).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span style="color:#65737e;">// Build the Arrays
</span><span style="color:#b48ead;">let</span><span> f1_array = f1_builder.</span><span style="color:#96b5b4;">finish</span><span>();
</span><span style="color:#b48ead;">let</span><span> f2_array = f2_builder.</span><span style="color:#96b5b4;">finish</span><span>();
</span><span style="color:#b48ead;">let</span><span> f3_array = f3_builder.</span><span style="color:#96b5b4;">finish</span><span>();
</span><span>
</span><span style="color:#65737e;">// Define Schema
</span><span style="color:#b48ead;">let</span><span> schema = Arc::new(Schema::new(vec![
</span><span>      Field::new(&quot;</span><span style="color:#a3be8c;">f1</span><span>&quot;, DataType::UInt64, </span><span style="color:#d08770;">false</span><span>),
</span><span>      Field::new(&quot;</span><span style="color:#a3be8c;">f2</span><span>&quot;, DataType::Utf8, </span><span style="color:#d08770;">false</span><span>),
</span><span>      Field::new(&quot;</span><span style="color:#a3be8c;">f3</span><span>&quot;, DataType::Float64, </span><span style="color:#d08770;">false</span><span>),
</span><span>]));
</span><span>
</span><span style="color:#65737e;">// Build up an Arrow RecordBatch using our Arrays and Schema
</span><span style="color:#b48ead;">let</span><span> batch = RecordBatch::try_new(
</span><span>    schema.</span><span style="color:#96b5b4;">clone</span><span>(),
</span><span>    vec![Arc::new(f1_array),
</span><span>         Arc::new(f2_array),
</span><span>         Arc::new(f3_array),
</span><span>    ],
</span><span>);
</span></code></pre>
<p>As you can see, the process of building up columnar data of the <code>Event</code> struct is a bit of a hassle. In Arcon, we have implemented an <code>Arrow</code> derive macro that hides this complexity from the user.</p>
<h2 id="arrow-derive-macro">Arrow Derive Macro</h2>
<p>Before diving into the <code>Arrow</code> derive macro, we first have to look at the <code>ToArrow</code> trait that the macro implements.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">/// Represents an Arcon type that can be converted to Arrow
</span><span style="color:#b48ead;">pub trait </span><span>ToArrow {
</span><span>    </span><span style="color:#65737e;">/// Type to help the runtime know which builder to use
</span><span>    </span><span style="color:#b48ead;">type </span><span>Builder: ArrayBuilder;
</span><span>    </span><span style="color:#65737e;">/// Returns the underlying Arrow [DataType]
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">arrow_type</span><span>() -&gt; DataType;
</span><span>    </span><span style="color:#65737e;">/// Return the Arrow Schema
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">schema</span><span>() -&gt; Schema;
</span><span>    </span><span style="color:#65737e;">/// Creates a new MutableTable
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">table</span><span>() -&gt; MutableTable;
</span><span>    </span><span style="color:#65737e;">/// Used to append `self` to an Arrow StructBuilder
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">append</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">builder</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> StructBuilder) -&gt; Result&lt;(), ArrowError&gt;;
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Macro used to implement ToArrow for non-struct types
</span><span style="color:#96b5b4;">macro_rules! </span><span>to_arrow {
</span><span>    (</span><span style="color:#bf616a;">$type</span><span>:</span><span style="color:#b48ead;">ty</span><span>, </span><span style="color:#bf616a;">$builder_type</span><span>:</span><span style="color:#b48ead;">ty</span><span>, </span><span style="color:#bf616a;">$arrow_type</span><span>:</span><span style="color:#b48ead;">expr</span><span>) =&gt; {
</span><span>        </span><span style="color:#b48ead;">impl </span><span>ToArrow </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">$type </span><span>{
</span><span>            </span><span style="color:#b48ead;">type </span><span>Builder = </span><span style="color:#bf616a;">$builder_type</span><span>;
</span><span>
</span><span>            </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">arrow_type</span><span>() -&gt; DataType {
</span><span>                </span><span style="color:#bf616a;">$arrow_type
</span><span>            }
</span><span>            </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">schema</span><span>() -&gt; Schema {
</span><span>                unreachable!(
</span><span>                    &quot;</span><span style="color:#a3be8c;">Operation not possible for single value {}</span><span>&quot;,
</span><span>                    stringify!(</span><span style="color:#bf616a;">$type</span><span>)
</span><span>                );
</span><span>            }
</span><span>            </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">table</span><span>() -&gt; MutableTable {
</span><span>                unreachable!(
</span><span>                    &quot;</span><span style="color:#a3be8c;">Operation not possible for single value {}</span><span>&quot;,
</span><span>                    stringify!(</span><span style="color:#bf616a;">$type</span><span>)
</span><span>                );
</span><span>            }
</span><span>            </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">append</span><span>(</span><span style="color:#bf616a;">self</span><span>, _: &amp;</span><span style="color:#b48ead;">mut</span><span> StructBuilder) -&gt; Result&lt;(), ArrowError&gt; {
</span><span>                unreachable!(
</span><span>                    &quot;</span><span style="color:#a3be8c;">Operation not possible for single value {}</span><span>&quot;,
</span><span>                    stringify!(</span><span style="color:#bf616a;">$type</span><span>)
</span><span>                );
</span><span>            }
</span><span>        }
</span><span>    };
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Map types to Arrow Types
</span><span>to_arrow!(</span><span style="color:#b48ead;">u64</span><span>, UInt64Builder, DataType::UInt64);
</span><span>to_arrow!(</span><span style="color:#b48ead;">u32</span><span>, UInt32Builder, DataType::UInt32);
</span><span>to_arrow!(</span><span style="color:#b48ead;">i64</span><span>, Int64Builder, DataType::Int64);
</span><span>to_arrow!(</span><span style="color:#b48ead;">i32</span><span>, Int32Builder, DataType::Int32);
</span><span>to_arrow!(</span><span style="color:#b48ead;">f64</span><span>, Float64Builder, DataType::Float64);
</span><span>to_arrow!(</span><span style="color:#b48ead;">f32</span><span>, Float32Builder, DataType::Float32);
</span><span>to_arrow!(</span><span style="color:#b48ead;">bool</span><span>, BooleanBuilder, DataType::Boolean);
</span><span>to_arrow!(String, StringBuilder, DataType::Utf8);
</span><span>to_arrow!(Vec&lt;</span><span style="color:#b48ead;">u8</span><span>&gt;, BinaryBuilder, DataType::Binary);
</span></code></pre>
<p>The <code>ToArrow</code> trait has an associated type called Builder which tells us what kind of Arrow ArrayBuilder we are working with.</p>
<p>We have so far not talked about Arrow's <a href="https://docs.rs/arrow/3.0.0/arrow/array/struct.StructBuilder.html">StructBuilder</a>, 
which is at the core of the macro. If we look back at the <code>Event</code> struct then a StructBuilder would contain the following child field builders: 
<code>UInt64Builder</code>, <code>StringBuilder</code>, and <code>Float64Builder</code>. We may access each child builder by its index position as we will see soon.</p>
<p>The derive macro will generate all the <code>ToArrow</code> methods for the <code>Event</code> struct.  It is in the table method that we construct the StructBuilder.
As long as we provide the StructBuilder with all the correct Arrow Fields, it will then take care of initialising every child field builder.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">// NOTE that this is Rust macro code that has yet to be expanded
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">table</span><span>() -&gt; ::arcon::MutableTable {
</span><span>  </span><span style="color:#b48ead;">let</span><span> builder = ::arcon::StructBuilder::from_fields(#fields, ::arcon::</span><span style="color:#d08770;">RECORD_BATCH_SIZE</span><span>);
</span><span>  </span><span style="color:#b48ead;">let</span><span> table_name = stringify!(#name).</span><span style="color:#96b5b4;">to_lowercase</span><span>();
</span><span>  ::arcon::MutableTable::new(::arcon::RecordBatchBuilder::new(table_name, </span><span style="color:#b48ead;">Self</span><span>::schema(), builder))
</span><span>}
</span></code></pre>
<p>A <code>MutableTable</code> then utilises the append method each time to add a record to the table. 
Down below you can see the generated code for the append method of <code>Event</code>.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">arcon</span><span>::</span><span style="color:#bf616a;">proto</span><span>]
</span><span>#[</span><span style="color:#bf616a;">derive</span><span>(Arcon, Arrow, Clone)]
</span><span style="color:#b48ead;">pub struct </span><span>Event {
</span><span>  </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">f1</span><span>: </span><span style="color:#b48ead;">u64</span><span>,
</span><span>  </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">f2</span><span>: String,
</span><span>  </span><span style="color:#b48ead;">pub </span><span style="color:#bf616a;">f3</span><span>: </span><span style="color:#b48ead;">f64</span><span>,
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Generated code
</span><span style="color:#b48ead;">impl </span><span>ToArrow </span><span style="color:#b48ead;">for </span><span>Event {
</span><span>  </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">append</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">builder</span><span>: &amp;</span><span style="color:#b48ead;">mut</span><span> StructBuilder) -&gt; Result&lt;(), ArrowError&gt; {
</span><span>    </span><span style="color:#b48ead;">let</span><span> value = </span><span style="color:#bf616a;">self</span><span>.f1;
</span><span>    </span><span style="color:#b48ead;">match</span><span> builder.field_builder::&lt;&lt;</span><span style="color:#b48ead;">u64</span><span>&gt;::Builder&gt;(</span><span style="color:#d08770;">0</span><span>) {
</span><span>        Some(b) =&gt; b.</span><span style="color:#96b5b4;">append_value</span><span>(value)?,
</span><span>        None =&gt; </span><span style="color:#b48ead;">return </span><span>Err(::arcon::ArrowError::SchemaError(format!(&quot;</span><span style="color:#a3be8c;">Failed to downcast Arrow Builder</span><span>&quot;))),
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> value = </span><span style="color:#bf616a;">self</span><span>.f2;
</span><span>    </span><span style="color:#b48ead;">match</span><span> builder.field_builder::&lt;&lt;String&gt;::Builder&gt;(</span><span style="color:#d08770;">1</span><span>) {
</span><span>        Some(b) =&gt; b.</span><span style="color:#96b5b4;">append_value</span><span>(value)?,
</span><span>        None =&gt; </span><span style="color:#b48ead;">return </span><span>Err(::arcon::ArrowError::SchemaError(format!(&quot;</span><span style="color:#a3be8c;">Failed to downcast Arrow Builder</span><span>&quot;))),
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> value = </span><span style="color:#bf616a;">self</span><span>.f3;
</span><span>    </span><span style="color:#b48ead;">match</span><span> builder.field_builder::&lt;&lt;</span><span style="color:#b48ead;">f64</span><span>&gt;::Builder&gt;(</span><span style="color:#d08770;">2</span><span>) {
</span><span>        Some(b) =&gt; b.</span><span style="color:#96b5b4;">append_value</span><span>(value)?,
</span><span>        None =&gt; </span><span style="color:#b48ead;">return </span><span>Err(::arcon::ArrowError::SchemaError(format!(&quot;</span><span style="color:#a3be8c;">Failed to downcast Arrow Builder</span><span>&quot;))),
</span><span>    }
</span><span>    Ok(())
</span><span>  }
</span><span>  ...
</span><span>}
</span></code></pre>
<p>Instead of working with low-level Arrow builders, we work directly with tables that hide the complexity of creating Arrow data.
In our manual example from <a href="https://cda-group.github.io/arcon/blog/arrow/#working-with-arrow">Working With Arrow</a>, we appended a single <code>Event</code> struct into Arrow data. By using our <code>Arrow</code> macro, the code can now be written as:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let mut</span><span> table = Event::table();
</span><span>
</span><span style="color:#b48ead;">let</span><span> event = Event { f1: </span><span style="color:#d08770;">1</span><span>, f2: String::from(&quot;</span><span style="color:#a3be8c;">data</span><span>&quot;), f3: </span><span style="color:#d08770;">10.5 </span><span>};
</span><span>table.</span><span style="color:#96b5b4;">append</span><span>(event);
</span></code></pre>
<h2 id="fixed-limitations">Fixed Limitations</h2>
<p>At first, we were not able to support <code>String</code> and <code>Vec&lt;u8&gt;</code> as their ArrayBuilder's were constrained to accept parameters as references while our macro passes things by value. This issue is now fixed as a <a href="https://github.com/apache/arrow/pull/9570">patch</a> was contributed upstream to Arrow.</p>
<h2 id="current-limitations">Current Limitations</h2>
<p>The <code>Arrow</code> derive macro cannot handle nested structs. That is, it does not know how to handle a StructBuilder within another StructBuilder.
We aim to fix this in the coming future, you can follow the progress <a href="https://github.com/cda-group/arcon/issues/153">here</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Arrow format has grown into an industry-standard where essentially every new data processing system builds on top of it.
Therefore, it makes sense for Arcon to join the Arrow ecosystem so that it can benefit both from Columnar processing and the
possibility of sharing internal Arcon data with other systems that use Arrow.</p>
<h2 id="references">References</h2>
<ol>
<li>Arcon's Github <a href="https://github.com/cda-group/arcon">repo</a></li>
<li>Arcon's Arrow derive <a href="https://github.com/cda-group/arcon/blob/master/arcon_macros/src/arrow.rs">macro</a>.</li>
<li>Arcon's table implemenation can be found <a href="https://github.com/cda-group/arcon/blob/master/src/table/mod.rs">here</a>.</li>
</ol>

        </article>
      </div>
    </div>
  </div>
</div>


  
    
<footer class="footer text-muted">
	<div class="container">
		<div class="row">
			<div class="col-lg-8 order-last order-lg-first">
				<ul class="list-inline">
					
						<li class="list-inline-item">Powered by <a href="https://www.getzola.org/">Zola</a> and <a href="https://github.com/aaranxu/adidoks">AdiDoks</a></li>
					
				</ul>
			</div>
			<div class="col-lg-8 order-first order-lg-last text-lg-end">
				<ul class="list-inline">
					
				</ul>
			</div>
		</div>
	</div>
</footer>

  

  
<script type="text/javascript" src="https://cda-group.github.io/arcon/js/main.js" defer></script>

  <script type="text/javascript" src="https://cda-group.github.io/arcon/plugins/elasticlunr.min.js" defer></script>
  <script type="text/javascript" src="https://cda-group.github.io/arcon/search_index.en.js" defer></script>
  <script type="text/javascript" src="https://cda-group.github.io/arcon/js/search.js" defer></script>

  
</body>
</html>
